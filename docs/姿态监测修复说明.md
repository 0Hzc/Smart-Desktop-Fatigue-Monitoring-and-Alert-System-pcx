# 姿态监测修复说明（更新版）

## 问题历史

### 第一次问题（已解决）
1. **Roll值异常**：显示-154.5°，正常范围应该是-10° ~ 10°
2. **警告未触发**：Pitch=11.2° 已超过阈值10°，但Posture仍显示"Normal"

### 第二次问题（当前修复）
使用`cv2.RQDecomp3x3`后出现更严重的问题：
1. **角度值完全错误**：
   - 抬头时：Pitch=156.1°（应该是负值如-15°）
   - 正常坐姿：Pitch=177.1°（应该接近0°）
   - 低头时：Pitch=-118.6°（应该是正值如15°）
2. **判定结果相反**：
   - 抬头 → 显示"Head Down"
   - 低头 → 显示"Head Up"
3. **Roll值仍然异常**：-179.8°

## 根本原因分析

### 错误1：使用了错误的函数

`cv2.RQDecomp3x3` **不是**用于提取头部姿态欧拉角的函数！
- 这个函数是用于相机标定的QR分解
- 用于将3x3矩阵分解为旋转矩阵和上三角矩阵
- 返回的角度是相机矩阵的分解角度，不是头部姿态角度

### 正确方法：手动从旋转矩阵提取欧拉角

需要使用标准的旋转矩阵到欧拉角转换公式（YXZ旋转顺序）

## 最终修复方案

### 修复：使用标准欧拉角提取方法

**修改文件**：`src/analysis/posture_monitor.py`

**错误方法**（已废弃）：
```python
# ❌ 错误！这是相机标定函数，不是姿态提取函数
euler_angles, _, _, _, _, _ = cv2.RQDecomp3x3(rotation_matrix)
```

**正确方法**（当前使用）：
```python
# ✓ 正确的旋转矩阵到欧拉角转换
rotation_matrix, _ = cv2.Rodrigues(rotation_vector)

# 计算sy用于判断万向锁
sy = math.sqrt(rotation_matrix[0, 0]**2 + rotation_matrix[1, 0]**2)

if not singular:
    pitch = math.atan2(-rotation_matrix[2, 0], sy)
    yaw = math.atan2(rotation_matrix[1, 0], rotation_matrix[0, 0])
    roll = math.atan2(rotation_matrix[2, 1], rotation_matrix[2, 2])
else:
    # 万向锁情况
    pitch = math.atan2(-rotation_matrix[2, 0], sy)
    yaw = math.atan2(-rotation_matrix[0, 1], rotation_matrix[1, 1])
    roll = 0

# 转换为度并调整符号
pitch = -math.degrees(pitch)  # 取反以匹配直观理解（低头为正）
yaw = math.degrees(yaw)
roll = math.degrees(roll)
```

**关键点**：
- 使用YXZ旋转顺序
- 对pitch取反，使低头为正值，仰头为负值（符合直观理解）
- 正确处理万向锁情况

### 修复2：统一阈值配置

**修改文件**：`src/analysis/posture_monitor.py` 的测试函数

**旧代码**：
```python
monitor = PostureMonitor(
    pitch_threshold_down=30.0,  # 硬编码
    pitch_threshold_up=-15.0,
    warning_duration=5.0
)
```

**新代码**：
```python
config = get_config(config_path)
posture_config = config.get_posture_config()
monitor = PostureMonitor(
    pitch_threshold_down=posture_config['pitch_threshold_down'],  # 从config读取
    pitch_threshold_up=posture_config['pitch_threshold_up'],
    warning_duration=5.0
)
```

## 当前配置

`config.yaml`中的阈值设置：
```yaml
posture:
  pitch_threshold_down: 12  # 低头阈值（度）- 需要根据新算法重新测试调整
  pitch_threshold_up: -8    # 仰头阈值（度）- 需要根据新算法重新测试调整
  warning_duration: 60      # 持续60秒触发警告
```

**⚠️ 注意**：这些阈值是基于旧的错误算法调整的，使用新算法后需要重新测试并调整！

## 测试步骤（重要！）

### 第一步：先拉取最新代码

```bash
git pull origin claude/review-project-plan-01HbXoRc4U8EzYeKMA6bxPxz
```

### 第二步：验证欧拉角计算是否正确

运行独立测试：
```bash
python src/analysis/posture_monitor.py
```

**测试动作与预期结果**：

| 动作 | Pitch预期值 | Yaw预期值 | Roll预期值 | Posture预期 |
|------|------------|-----------|-----------|------------|
| **正常坐姿** | -5° ~ 5° | -5° ~ 5° | -10° ~ 10° | Normal（绿色） |
| **低头** | 10° ~ 30°（正值） | -5° ~ 5° | -10° ~ 10° | Head Down（红色） |
| **仰头** | -10° ~ -30°（负值） | -5° ~ 5° | -10° ~ 10° | Head Up（橙色） |
| **左转头** | -5° ~ 5° | -20° ~ -40°（负值） | -10° ~ 10° | Normal |
| **右转头** | -5° ~ 5° | 20° ~ 40°（正值） | -10° ~ 10° | Normal |

**重点验证**：
1. ✅ **低头时Pitch为正值**（如15°），而不是负值或超大值
2. ✅ **仰头时Pitch为负值**（如-15°），而不是正值或超大值
3. ✅ **Roll值始终在-10° ~ 10°范围内**，不再出现-154°或-179°这样的异常值
4. ✅ **低头时显示"Head Down"**，不是"Head Up"
5. ✅ **仰头时显示"Head Up"**，不是"Head Down"

### 第三步：测试并记录角度范围

请完成以下测试并记录数据：

1. **保持正常坐姿**，记录：
   - Pitch = ___°
   - Roll = ___°

2. **尽量低头（同时保持面部可被识别）**，记录：
   - Pitch = ___°（应该是正值，如15-25°）
   - Roll = ___°

3. **尽量仰头（同时保持面部可被识别）**，记录：
   - Pitch = ___°（应该是负值，如-10到-20°）
   - Roll = ___°

### 第四步：根据实测数据调整阈值

根据你记录的最大低头和仰头角度，我们会调整`config.yaml`中的阈值：

```yaml
posture:
  pitch_threshold_down: [你的最大低头角度 × 0.7]  # 例如：最大25°，则设为18°
  pitch_threshold_up: [你的最大仰头角度 × 0.7]    # 例如：最大-15°，则设为-10°
  warning_duration: 60
```

## 如果问题仍存在

如果角度值仍然异常，请提供：

### 必需信息：

1. **截图**：包含Pitch、Yaw、Roll、Posture的实时显示
2. **当前动作**：正常坐姿/低头/仰头/左转/右转
3. **终端输出**：特别是初始化信息和任何错误

### 参考对比表：

| 情况 | Pitch | Roll | 判断 |
|-----|-------|------|------|
| ✅ **正确** | 低头=15°, 仰头=-12° | -5° ~ 5° | 算法工作正常 |
| ❌ **仍然错误** | 低头=-118°, 仰头=156° | -179° | 算法仍有问题 |

## 技术说明

### 为什么不能用cv2.RQDecomp3x3？

| 函数 | 用途 | 适用场景 |
|------|------|---------|
| **cv2.RQDecomp3x3** | QR分解，用于相机标定 | ❌ 不适合头部姿态估计 |
| **手动欧拉角提取** | 从旋转矩阵计算欧拉角 | ✅ 正确的头部姿态方法 |

### 坐标系约定

OpenCV摄像头坐标系：
- **X轴**：指向右
- **Y轴**：指向下
- **Z轴**：指向前（远离摄像头）

欧拉角定义：
- **Pitch（俯仰）**：绕X轴旋转，低头为正，仰头为负
- **Yaw（偏航）**：绕Y轴旋转，左转为负，右转为正
- **Roll（翻滚）**：绕Z轴旋转，左倾为负，右倾为正

---

**文档版本**: v1.0
**创建日期**: 2025-01-20
**修复提交**: commit 9f5824b
