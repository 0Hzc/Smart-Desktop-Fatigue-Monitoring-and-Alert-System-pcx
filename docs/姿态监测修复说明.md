# 姿态监测修复说明

## 问题描述

在阶段3测试中发现以下问题：

1. **Roll值异常**：显示-154.5°，正常范围应该是-10° ~ 10°
2. **警告未触发**：Pitch=11.2° 已超过阈值10°，但Posture仍显示"Normal"

## 根本原因分析

### 问题1：欧拉角计算错误

之前使用手动方法从旋转矩阵提取欧拉角，可能存在：
- 坐标系转换错误
- 旋转顺序不匹配
- Gimbal Lock处理不当

### 问题2：阈值配置不一致

测试函数中使用的是硬编码的旧阈值（30°, -15°），而不是config.yaml中的新阈值（12°, -8°）

## 修复方案

### 修复1：使用OpenCV内置函数提取欧拉角

**修改文件**：`src/analysis/posture_monitor.py`

**旧方法**：手动从旋转矩阵计算
```python
sin_x = rotation_matrix[2, 1]
pitch = math.asin(sin_x)
# ... 复杂的手动计算
```

**新方法**：使用`cv2.RQDecomp3x3`
```python
euler_angles, _, _, _, _, _ = cv2.RQDecomp3x3(rotation_matrix)
pitch = euler_angles[0]
yaw = euler_angles[1]
roll = euler_angles[2]
```

**优势**：
- OpenCV专门用于欧拉角分解的函数
- 更可靠，避免坐标系转换错误
- 自动处理Gimbal Lock

### 修复2：统一阈值配置

**修改文件**：`src/analysis/posture_monitor.py` 的测试函数

**旧代码**：
```python
monitor = PostureMonitor(
    pitch_threshold_down=30.0,  # 硬编码
    pitch_threshold_up=-15.0,
    warning_duration=5.0
)
```

**新代码**：
```python
config = get_config(config_path)
posture_config = config.get_posture_config()
monitor = PostureMonitor(
    pitch_threshold_down=posture_config['pitch_threshold_down'],  # 从config读取
    pitch_threshold_up=posture_config['pitch_threshold_up'],
    warning_duration=5.0
)
```

## 当前配置

`config.yaml`中的阈值设置：
```yaml
posture:
  pitch_threshold_down: 12  # 低头阈值（根据实测调整）
  pitch_threshold_up: -8    # 仰头阈值（根据实测调整）
  warning_duration: 60      # 持续60秒触发警告
```

## 测试步骤

### 测试1：验证欧拉角计算

运行独立测试：
```bash
python src/analysis/posture_monitor.py
```

**预期结果**：
- **Pitch**：正常坐姿 -5° ~ 5°，低头时增大（正值），仰头时减小（负值）
- **Yaw**：左转为负，右转为正，范围 -30° ~ 30°
- **Roll**：头部倾斜角度，**正常范围 -10° ~ 10°**（重点检查！）

**测试动作**：
1. 保持正常坐姿 → Roll应该接近0°
2. 低头 → Pitch应该>0，Roll仍在-10° ~ 10°
3. 仰头 → Pitch应该<0，Roll仍在-10° ~ 10°
4. 左右转头 → Yaw变化，Roll保持正常

### 测试2：验证阈值触发

**测试低头检测**：
1. 运行测试：`python src/analysis/posture_monitor.py`
2. 保持正常坐姿（Pitch < 12°）
3. 预期：Posture显示"Normal"（绿色）
4. **低头使Pitch > 12°**
5. **预期：Posture立即变为"Head Down"（红色）**
6. 持续5秒后（测试版缩短的warning_duration）
7. 预期：屏幕中央显示"! BAD POSTURE WARNING !"

**测试仰头检测**：
1. 保持正常坐姿
2. **仰头使Pitch < -8°**
3. **预期：Posture立即变为"Head Up"（橙色）**
4. 持续5秒后触发警告

### 测试3：完整系统测试

运行完整系统：
```bash
python main.py
```

验证：
1. 所有指标正常显示
2. Pitch、Yaw、Roll值都在合理范围
3. 低头/仰头能正确检测
4. 综合健康分数正确计算

## 验证清单

完成测试后，请验证：

- [ ] Roll值在正常范围内（-10° ~ 10°），不再出现-154°这样的异常值
- [ ] Pitch > 12° 时，Posture立即显示"Head Down"
- [ ] Pitch < -8° 时，Posture立即显示"Head Up"
- [ ] 持续不良坐姿5秒后（测试版）显示警告
- [ ] 完整系统运行正常，无报错

## 如果问题仍存在

如果Roll值仍然异常或警告仍不触发，请提供：

1. **运行哪个程序**：
   - 运行的是 `python main.py` 还是 `python src/analysis/posture_monitor.py`？

2. **屏幕截图**，包含：
   - Pitch、Yaw、Roll的实时数值
   - Posture状态
   - 左上角的配置阈值提示

3. **测试动作**：
   - 当前是什么姿势（正常/低头/仰头）

4. **终端输出**：
   - 初始化时显示的阈值配置
   - 任何错误信息

## 技术说明

### cv2.RQDecomp3x3 vs 手动计算

| 方法 | 优势 | 劣势 |
|------|------|------|
| **cv2.RQDecomp3x3** | OpenCV内置，经过充分测试，自动处理边界情况 | 需要理解OpenCV的坐标系约定 |
| **手动计算** | 灵活，可自定义 | 容易出错，需要处理Gimbal Lock |

### 坐标系约定

OpenCV摄像头坐标系：
- **X轴**：指向右
- **Y轴**：指向下
- **Z轴**：指向前（远离摄像头）

欧拉角定义：
- **Pitch（俯仰）**：绕X轴旋转，低头为正，仰头为负
- **Yaw（偏航）**：绕Y轴旋转，左转为负，右转为正
- **Roll（翻滚）**：绕Z轴旋转，左倾为负，右倾为正

---

**文档版本**: v1.0
**创建日期**: 2025-01-20
**修复提交**: commit 9f5824b
