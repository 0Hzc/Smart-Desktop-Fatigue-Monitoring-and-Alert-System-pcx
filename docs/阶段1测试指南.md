# 阶段1 测试指南

## 环境搭建与基础框架验收

### 前置条件

1. **Python环境**：Python 3.9+
2. **摄像头**：电脑内置摄像头或外接USB摄像头

### 安装依赖

```bash
# 进入项目目录
cd Smart-Desktop-Fatigue-Monitoring-and-Alert-System-pcx

# 安装依赖库
pip install -r requirements.txt

# 如果在树莓派上，还需要安装：
# pip install picamera2 RPi.GPIO
```

### 测试1：配置加载测试

```bash
# 测试配置加载模块
python src/utils/config_loader.py
```

**预期输出**：
```
✓ 配置文件加载成功: config.yaml

=== 配置测试 ===
摄像头分辨率: 640x480
EAR阈值: 0.25
警告距离: 50 cm
低头阈值: 30°
启用语音提醒: True
```

### 测试2：摄像头采集测试

```bash
# 测试摄像头模块
python src/camera/camera_capture.py
```

**预期效果**：
- 弹出窗口显示摄像头画面
- 左上角显示实时FPS
- 画面流畅（≥15 FPS）
- 按 'q' 键可正常退出

**故障排除**：
- 如果提示"无法打开摄像头"，检查摄像头是否被其他程序占用
- 如果帧率过低，尝试降低分辨率（修改config.yaml）

### 测试3：人脸检测测试

```bash
# 测试人脸检测模块
python src/detection/face_detector.py
```

**预期效果**：
- 弹出窗口显示摄像头画面
- 检测到人脸时：
  - 绘制绿色人脸网格
  - 眼部关键点用蓝色高亮显示
  - 显示"Landmarks: 468"
  - 绘制人脸边界框
- 未检测到人脸时显示提示信息
- FPS ≥15

**关键指标**：
- ✅ 能准确检测正面人脸
- ✅ 眼部关键点位置准确
- ✅ 头部轻微转动时仍能追踪
- ✅ 帧率稳定在15 FPS以上

### 测试4：完整系统测试

```bash
# 运行主程序
python main.py
```

**预期效果**：
```
==================================================
智能桌面疲劳监测系统
版本: v1.0
==================================================
✓ 配置文件加载成功: config.yaml
✓ 摄像头启动成功: 640x480
✓ MediaPipe人脸检测器初始化成功
  - 最多检测人脸数: 1
  - 检测置信度: 0.5
  - 跟踪置信度: 0.5

✓ 系统初始化完成

启动系统...
✓ 系统运行中... 按 'Q' 键退出
```

**窗口显示**：
- 实时视频画面
- FPS显示
- 帧计数显示
- 人脸检测状态（"Face Detected" 或 "No Face Detected"）
- 人脸网格和眼部关键点标注

### 测试5：性能测试

**测试场景**：

| 场景 | 预期FPS | 验收标准 |
|------|---------|---------|
| 正常光照、正面人脸 | ≥20 FPS | ✅ 通过 |
| 侧脸（45°以内） | ≥18 FPS | ✅ 通过 |
| 弱光环境 | ≥15 FPS | ✅ 通过 |
| 未检测到人脸 | ≥25 FPS | ✅ 通过 |

**测试方法**：
1. 运行主程序
2. 观察窗口左上角FPS显示
3. 尝试不同角度和光照条件
4. 记录FPS数值

### 验收标准（阶段1）

#### ✅ 必须满足的条件

- [ ] 项目目录结构创建完整
- [ ] 配置文件可正常加载
- [ ] 摄像头可正常启动并采集画面
- [ ] MediaPipe可检测人脸并提取468个关键点
- [ ] 眼部关键点位置准确
- [ ] 系统帧率 ≥15 FPS
- [ ] 程序可正常启动和退出
- [ ] 无内存泄漏（长时间运行不崩溃）

#### 🎯 推荐达到的标准

- [ ] FPS ≥20（优秀）
- [ ] 侧脸45°内仍能检测
- [ ] 弱光环境下仍能工作
- [ ] 人脸快速移动时不丢失追踪

### 常见问题

#### Q1: ModuleNotFoundError: No module named 'cv2'
**A**: 安装OpenCV
```bash
pip install opencv-python
```

#### Q2: ModuleNotFoundError: No module named 'mediapipe'
**A**: 安装MediaPipe
```bash
pip install mediapipe
```

#### Q3: 摄像头无法打开
**A**:
1. 检查摄像头是否被占用（关闭其他视频软件）
2. 尝试修改camera_id（在config.yaml或代码中）
3. Linux系统检查权限：`sudo usermod -a -G video $USER`

#### Q4: FPS很低（<10）
**A**:
1. 降低分辨率（修改config.yaml中的resolution）
2. 启用跳帧（修改skip_frames）
3. 关闭refine_landmarks
4. 检查CPU占用率

#### Q5: 检测不到人脸
**A**:
1. 确保光照充足
2. 面向摄像头（正面或侧面<45°）
3. 降低min_detection_confidence（改为0.3）
4. 调整摄像头位置

### 下一步

阶段1完成后，进入**阶段2：疲劳检测功能实现**

主要任务：
- EAR计算
- 眨眼检测
- PERCLOS统计
- 长时间闭眼检测

---

**文档版本**: v1.0
**最后更新**: 2025-01-19
