# 阶段2 测试指南

## 疲劳检测功能验收

### 概述

阶段2实现了疲劳监测系统的核心算法功能：
- ✅ **EAR计算**（Eye Aspect Ratio，眼睛纵横比）
- ✅ **眨眼检测与统计**
- ✅ **PERCLOS计算**（Percentage of Eyelid Closure，闭眼时间百分比）
- ✅ **长时间闭眼检测**（打瞌睡检测）
- ✅ **疲劳等级评估**（4级：正常/轻度/中度/重度）

---

## 测试方法

### 测试1：独立模块测试

测试疲劳分析器的独立功能：

```bash
python src/analysis/fatigue_analyzer.py
```

**预期效果**：
- 弹出窗口显示实时检测画面
- 左侧显示检测指标：
  - EAR值（实时）
  - 眨眼次数
  - PERCLOS百分比
  - 闭眼时长（闭眼时显示）
  - 疲劳状态
- 打瞌睡时屏幕中央显示红色警告

**测试动作**：
1. **正常状态**：睁眼看向摄像头
   - EAR应该 > 0.25
   - 状态显示"正常"（绿色）

2. **眨眼测试**：频繁眨眼
   - 眨眼计数器应该增加
   - EAR值应该快速下降又上升

3. **闭眼测试**：闭眼持续2秒以上
   - 闭眼时长计时器开始计时
   - 超过2秒后显示"DROWSY DETECTED"红色警告

4. **疲劳模拟**：长时间半闭眼状态
   - PERCLOS值应该上升
   - 疲劳等级从"正常"变为"轻度"或"中度"

---

### 测试2：完整系统测试

运行集成了疲劳检测的完整系统：

```bash
python main.py
```

**预期输出**：
```
==================================================
智能桌面疲劳监测系统
版本: v1.0
==================================================
✓ 配置文件加载成功: config.yaml
✓ 摄像头启动成功: 640x480
✓ MediaPipe人脸检测器初始化成功
  - 最多检测人脸数: 1
  - 检测置信度: 0.5
  - 跟踪置信度: 0.5
✓ 疲劳分析器初始化成功
  - EAR阈值: 0.25
  - PERCLOS阈值: 15.0%
  - PERCLOS窗口: 60秒
  - 眨眼频率范围: 10-30次/分钟
  - 闭眼警报时长: 2.0秒

✓ 系统初始化完成

启动系统...
✓ 系统运行中... 按 'Q' 键退出
```

**界面显示**：

#### 左侧信息面板
```
FPS: 20.5                    [绿色]
Frame: 1234                  [绿色]
EAR: 0.287                   [绿色，闭眼时变红]
Blinks: 15 (18/min)          [绿色]
PERCLOS: 8.5%                [绿色，超过15%变橙色]
Closed: 1.2s                 [闭眼时显示，超过2秒变红]
Status: 正常                  [颜色随疲劳等级变化]
```

#### 右上角疲劳指示条
- 只在疲劳时显示
- 颜色从黄色→橙色→红色
- 长度表示疲劳程度

#### 中央警告（打瞌睡时）
```
┌────────────────────────────┐
│  ! DROWSINESS ALERT !      │  [红底白字，醒目]
└────────────────────────────┘
```

---

## 功能验证清单

### ✅ EAR计算

| 测试项 | 操作 | 预期EAR值 | 预期状态 |
|--------|------|----------|---------|
| 睁眼 | 正常睁眼 | 0.25 - 0.35 | 正常 |
| 半闭眼 | 半闭眼睛 | 0.15 - 0.25 | 临界 |
| 闭眼 | 完全闭眼 | < 0.15 | CLOSED |

**验收标准**：
- ✅ EAR值实时更新，数值合理
- ✅ 闭眼时EAR < 0.25，显示"(CLOSED)"
- ✅ 睁眼时EAR > 0.25

---

### ✅ 眨眼检测

**测试步骤**：
1. 运行系统，正常眨眼20次
2. 观察眨眼计数器是否准确递增

| 实际眨眼次数 | 检测到的次数 | 准确率 | 结果 |
|------------|------------|-------|------|
| 20次 | 18-22次 | 90%+ | ✅ 通过 |
| 10次 | 9-11次 | 90%+ | ✅ 通过 |

**验收标准**：
- ✅ 眨眼计数准确率 ≥85%
- ✅ 不会将头部晃动误判为眨眼
- ✅ 快速眨眼也能检测到

---

### ✅ PERCLOS计算

**测试步骤**：
1. 运行系统60秒
2. 前30秒正常睁眼，后30秒半闭眼
3. 观察PERCLOS值变化

**预期结果**：
- 前30秒：PERCLOS < 10%
- 后30秒：PERCLOS 逐渐上升至 40-50%

**验收标准**：
- ✅ PERCLOS值实时更新
- ✅ 长时间睁眼时PERCLOS < 10%
- ✅ 长时间闭眼时PERCLOS > 50%
- ✅ PERCLOS > 15%时颜色变为橙色

---

### ✅ 长时间闭眼检测

**测试步骤**：
1. 闭眼1秒 → 睁眼
2. 闭眼2秒 → 睁眼
3. 闭眼3秒 → 睁眼

**预期结果**：

| 闭眼时长 | 是否警报 | 屏幕显示 |
|---------|---------|---------|
| 1秒 | ❌ | 显示"Closed: 1.0s"（橙色） |
| 2秒 | ✅ | 显示"Closed: 2.0s"（红色）+ 中央警告 |
| 3秒 | ✅ | 显示"Closed: 3.0s"（红色）+ 中央警告 |

**验收标准**：
- ✅ 闭眼时长计时准确
- ✅ 超过2秒触发打瞌睡警报
- ✅ 睁眼后计时器立即归零

---

### ✅ 疲劳等级评估

**等级定义**：
- **Level 0 - 正常**（绿色）：PERCLOS < 10%，眨眼正常
- **Level 1 - 轻度疲劳**（黄色）：PERCLOS 10-15% 或 眨眼异常
- **Level 2 - 中度疲劳**（橙色）：PERCLOS 15-20% 或 短暂打瞌睡
- **Level 3 - 重度疲劳**（红色）：PERCLOS > 20% 或 打瞌睡

**测试步骤**：

| 模拟场景 | 预期等级 | 文字颜色 |
|---------|---------|---------|
| 正常睁眼，正常眨眼 | Level 0 | 绿色 |
| 眨眼很少（<10次/分钟） | Level 1 | 黄色 |
| 长时间半闭眼（PERCLOS 16%） | Level 2 | 橙色 |
| 闭眼超过2秒 | Level 3 | 红色 |

**验收标准**：
- ✅ 疲劳等级评估准确
- ✅ 颜色编码正确
- ✅ 右上角指示条长度正确

---

## 性能指标

### 帧率测试

| 场景 | 最低FPS | 推荐FPS | 实际FPS |
|------|---------|---------|---------|
| 检测到人脸 | ≥15 | ≥20 | ___ |
| 未检测到人脸 | ≥20 | ≥25 | ___ |

**验收标准**：
- ✅ 启用疲劳检测后FPS仍 ≥15
- ✅ 无明显卡顿

### 准确性测试

| 指标 | 目标准确率 | 测试方法 |
|------|----------|---------|
| EAR计算 | 95%+ | 对比手动标注 |
| 眨眼检测 | 85%+ | 实际眨眼vs检测到的 |
| 闭眼检测 | 90%+ | 闭眼时是否准确判定 |
| 打瞌睡检测 | 95%+ | 闭眼2秒必须触发 |

---

## 常见问题

### Q1: EAR值一直很低（<0.2）
**可能原因**：
- 眼睛本身就小
- 光照不足，关键点检测不准
- 佩戴眼镜反光

**解决方案**：
```yaml
# 调整config.yaml中的EAR阈值
fatigue:
  ear_threshold: 0.20  # 降低阈值（原来0.25）
```

### Q2: 眨眼检测不准确
**可能原因**：
- 帧率太低
- 眨眼速度太快
- 光照变化剧烈

**解决方案**：
- 提高摄像头帧率
- 改善光照条件
- 调整检测灵敏度

### Q3: PERCLOS一直很高
**可能原因**：
- EAR阈值设置不合理
- 眼睛习惯性半闭

**解决方案**：
```yaml
# 调整EAR阈值或PERCLOS阈值
fatigue:
  ear_threshold: 0.23  # 降低阈值
  perclos_threshold: 0.20  # 提高PERCLOS警报阈值
```

### Q4: 打瞌睡警报触发太频繁
**解决方案**：
```yaml
# 延长闭眼触发时长
fatigue:
  closed_eye_duration: 3.0  # 改为3秒（原来2秒）
```

### Q5: 程序运行一段时间后变慢
**可能原因**：
- 内存泄漏
- PERCLOS历史数据过多

**排查方法**：
```bash
# 监控内存占用
top -p $(pgrep -f "python main.py")
```

---

## 代码质量检查

### 算法正确性

```python
# 验证EAR计算公式
def test_ear_calculation():
    """测试EAR计算是否正确"""
    # 构造测试数据：正方形眼睛
    eye_landmarks = np.array([
        [0, 0],    # 左眼角
        [1, 1],    # 上左
        [3, 1],    # 上右
        [4, 0],    # 右眼角
        [3, -1],   # 下右
        [1, -1]    # 下左
    ])

    ear = FatigueAnalyzer.calculate_ear(eye_landmarks)
    print(f"正方形眼睛EAR: {ear:.3f}")
    # 预期值约为0.5
```

### 边界条件测试

- ✅ 人脸突然消失
- ✅ 人脸重新出现
- ✅ 侧脸（45°以内）
- ✅ 戴眼镜
- ✅ 弱光环境
- ✅ 强光环境

---

## 演示场景

为毕业答辩准备以下演示：

### 场景1：正常工作状态（30秒）
- 正常眨眼
- EAR保持正常
- 疲劳等级：Level 0（绿色）

### 场景2：轻度疲劳（30秒）
- 减少眨眼频率
- 偶尔半闭眼
- 疲劳等级：Level 1（黄色）

### 场景3：打瞌睡检测（15秒）
- 闭眼超过2秒
- 触发红色警报
- 疲劳等级：Level 3（红色）

### 场景4：恢复清醒（15秒）
- 睁眼并正常眨眼
- PERCLOS逐渐下降
- 疲劳等级恢复到Level 0

---

## 验收标准总结

### 必须满足（阶段2）

- [x] EAR计算正确，数值合理（0.15-0.35）
- [x] 眨眼检测准确率 ≥85%
- [x] PERCLOS值实时更新且准确
- [x] 闭眼超过2秒触发警报
- [x] 疲劳等级评估准确
- [x] 界面显示完整清晰
- [x] FPS保持 ≥15
- [x] 程序稳定运行，无崩溃

### 推荐达到

- [ ] 眨眼检测准确率 ≥90%
- [ ] FPS ≥20
- [ ] 支持戴眼镜检测
- [ ] 弱光环境下仍能工作

---

## 下一步

阶段2完成后，进入**阶段3：距离与坐姿监测**

主要任务：
- 摄像头焦距校准
- 距离计算（基于人脸框大小）
- 头部姿态估计（Pitch、Yaw、Roll）
- 坐姿判定逻辑

---

**文档版本**: v1.0
**最后更新**: 2025-01-19
**测试状态**: ✅ 待验证
