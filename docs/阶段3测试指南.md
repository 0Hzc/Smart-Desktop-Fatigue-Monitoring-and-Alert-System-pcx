# 阶段3 测试指南

## 距离与坐姿监测验收

### 概述

阶段3实现了距离监测和坐姿监测两大功能：
- ✅ **距离监测**：估算用户与屏幕距离，过近时提醒
- ✅ **坐姿监测**：检测头部姿态，识别低头等不良坐姿
- ✅ **综合健康评分**：整合疲劳、距离、坐姿的综合指标

---

## 测试方法

### 测试1：距离监测独立测试

```bash
python src/analysis/distance_monitor.py
```

**功能**：
- 实时显示距离（厘米）
- 距离状态：Unknown / Too Close / Close / Normal / Far
- 距离过近持续计时
- 超过设定时间显示红色警告

**测试步骤**：

#### Step 1: 正常距离（60-80cm）
- **操作**：坐在摄像头前60-80cm
- **预期**：
  - Distance: 60-80 cm（绿色）
  - Status: Normal
  - 人脸框：绿色

#### Step 2: 靠近测试（< 50cm）
- **操作**：逐渐靠近摄像头，距离<50cm
- **预期**：
  - Distance: <50 cm（变红色）
  - Status: Too Close
  - 人脸框：红色
  - 开始计时："Too Close: X.Xs"

#### Step 3: 持续过近（> 30秒）
- **操作**：保持距离<50cm超过30秒（测试版缩短为5秒）
- **预期**：
  - 屏幕中央显示："! TOO CLOSE WARNING !"（红底白字）

#### Step 4: 远离测试（> 100cm）
- **操作**：远离摄像头，距离>100cm
- **预期**：
  - Distance: >100 cm
  - Status: Far
  - 计时器归零

**验收标准**：
- [x] 距离估算相对准确（误差<15cm可接受）
- [x] 距离<50cm能正确检测
- [x] 持续计时准确
- [x] 警告触发正常

---

### 测试2：焦距校准（可选）

如果距离估算误差较大，可进行焦距校准：

```bash
python src/analysis/distance_monitor.py
```

**校准步骤**：
1. 用尺子测量实际距离（如50cm）
2. 保持这个距离，按 'C' 键
3. 输入实际测量距离：`50`
4. 记录计算出的焦距值
5. 更新 `config.yaml` 中的 `focal_length`

**示例**：
```
请输入实际测量距离（厘米）: 50
✓ 焦距校准完成: 587.3 px
  - 测量距离: 50.0 cm
  - 人脸框宽度: 180 px
  - 请更新config.yaml中的focal_length为: 587.3
```

---

### 测试3：坐姿监测独立测试

```bash
python src/analysis/posture_monitor.py
```

**功能**：
- 实时显示头部姿态角度（Pitch/Yaw/Roll）
- 绘制3D坐标轴（X红/Y绿/Z蓝）
- 坐姿类型判定
- 不良坐姿警告

**测试步骤**：

#### Step 1: 正常坐姿
- **操作**：端正坐姿，平视摄像头
- **预期**：
  - Pitch: -5° ~ 5°（绿色）
  - Posture: Normal
  - 坐标轴方向正常

#### Step 2: 低头测试
- **操作**：低头超过30°
- **预期**：
  - Pitch: >30°（变红色）
  - Posture: Head Down（红色）
  - Z轴（蓝色）向下倾斜

#### Step 3: 仰头测试
- **操作**：仰头超过15°
- **预期**：
  - Pitch: <-15°（橙色）
  - Posture: Head Up（橙色）
  - Z轴（蓝色）向上倾斜

#### Step 4: 持续不良坐姿（> 60秒）
- **操作**：保持低头姿势超过60秒（测试版5秒）
- **预期**：
  - Bad Duration: 计时显示
  - 超过阈值后屏幕中央显示："! BAD POSTURE WARNING !"

#### Step 5: 左右转头
- **操作**：向左/右转头
- **预期**：
  - Yaw: 变化（向左为负，向右为正）
  - X轴（红色）方向变化

**角度参考**：
- **Pitch（俯仰角）**：
  - -5° ~ 5°：正常
  - 5° ~ 30°：略微低头
  - >30°：低头（触发）
  - <-15°：仰头（触发）

- **Yaw（偏航角）**：
  - -30° ~ 30°：正常范围
  - 超出：转头过大

- **Roll（翻滚角）**：
  - -10° ~ 10°：正常
  - 超出：头部倾斜

**验收标准**：
- [x] Pitch角度计算准确
- [x] 低头>30°能正确检测
- [x] 坐姿状态判定准确
- [x] 3D坐标轴显示正确
- [x] 警告触发正常

---

### 测试4：完整系统测试

```bash
python main.py
```

**预期界面**：

#### 左侧信息面板
```
FPS: 18.5
Frame: 2345

EAR: 0.285              [绿色]
PERCLOS: 5.2%           [绿色]
Fatigue: Normal         [绿色]
Distance: 65.3 cm       [绿色]
Posture: Normal         [绿色]
```

#### 右上角：综合健康分数
```
┌──────────────────┐
│████████░░  80%   │  [绿色进度条]
└──────────────────┘
```

**综合场景测试**：

#### 场景1：完全健康状态
- **条件**：
  - 疲劳：Normal
  - 距离：60-80cm
  - 坐姿：Normal
- **预期**：健康分数 = 100%（绿色）

#### 场景2：轻度疲劳
- **条件**：
  - 疲劳：Mild Fatigue
  - 距离：正常
  - 坐姿：正常
- **预期**：健康分数 = 80%（黄色）

#### 场景3：距离过近
- **条件**：
  - 疲劳：Normal
  - 距离：<50cm持续30秒
  - 坐姿：正常
- **预期**：
  - 健康分数 = 80%
  - 屏幕中央："TOO CLOSE!"

#### 场景4：坐姿不良
- **条件**：
  - 疲劳：Normal
  - 距离：正常
  - 坐姿：Head Down持续60秒
- **预期**：
  - 健康分数 = 80%
  - 屏幕中央："HEAD DOWN!"

#### 场景5：多重问题
- **条件**：
  - 疲劳：Severe Fatigue（闭眼>2秒）
  - 距离：<50cm
  - 坐姿：Head Down
- **预期**：
  - 健康分数 = 0%（红色）
  - 屏幕中央："DROWSINESS! | TOO CLOSE! | HEAD DOWN!"

---

## 功能验证清单

### ✅ 距离监测

| 测试项 | 实际距离 | 估算距离 | 误差 | 状态 | 结果 |
|--------|---------|---------|------|------|------|
| 近距离 | 30cm | ___ cm | ___ | Too Close | [ ] |
| 临界距离 | 50cm | ___ cm | ___ | Close | [ ] |
| 正常距离 | 70cm | ___ cm | ___ | Normal | [ ] |
| 远距离 | 100cm | ___ cm | ___ | Far | [ ] |

**验收标准**：
- [x] 误差 < 15cm
- [x] 距离<50cm警告触发
- [x] 持续计时准确

---

### ✅ 坐姿监测

| 测试项 | 实际姿态 | 检测Pitch | 状态 | 结果 |
|--------|---------|-----------|------|------|
| 正常坐姿 | 平视 | -5° ~ 5° | Normal | [ ] |
| 略微低头 | 低头15° | 10° ~ 20° | Normal | [ ] |
| 明显低头 | 低头40° | >30° | Head Down | [ ] |
| 仰头 | 仰头20° | <-15° | Head Up | [ ] |

**验收标准**：
- [x] Pitch角度计算准确
- [x] 低头>30°触发警告
- [x] 仰头<-15°触发警告

---

### ✅ 综合健康评分

| 疲劳等级 | 距离状态 | 坐姿状态 | 预期分数 | 实际分数 | 结果 |
|---------|---------|---------|---------|---------|------|
| Normal | Normal | Normal | 100% | ___ % | [ ] |
| Mild | Normal | Normal | 80% | ___ % | [ ] |
| Normal | Too Close | Normal | 80% | ___ % | [ ] |
| Normal | Normal | Head Down | 80% | ___ % | [ ] |
| Severe | Too Close | Head Down | 0% | ___ % | [ ] |

---

## 性能测试

### 帧率测试

| 功能启用 | 目标FPS | 实际FPS | 状态 |
|---------|---------|---------|------|
| 仅人脸检测 | ≥20 | ___ | [ ] |
| +疲劳检测 | ≥18 | ___ | [ ] |
| +距离监测 | ≥16 | ___ | [ ] |
| +坐姿监测（完整） | ≥15 | ___ | [ ] |

**验收标准**：完整系统FPS ≥15

---

## 常见问题

### Q1: 距离估算误差很大？
**A**: 需要焦距校准
1. 用尺子测量实际距离
2. 按 'C' 键校准
3. 更新config.yaml中的focal_length

### Q2: Pitch角度跳动剧烈？
**A**: 这是正常现象，可以：
1. 改善光照条件
2. 保持面部正对摄像头
3. 添加角度平滑（滑动平均）

### Q3: 综合分数一直很低？
**A**: 检查各项指标：
- 疲劳等级是否正常？
- 距离是否在正常范围？
- 坐姿是否端正？

### Q4: 距离>50cm但仍显示Too Close？
**A**: 焦距参数不准确，需要校准

### Q5: 低头但没有触发警告？
**A**: 检查：
1. Pitch值是否>30°？
2. 持续时间是否>60秒？
3. config.yaml中的阈值设置

---

## 性能优化建议

如果FPS < 15：

1. **降低分辨率**：
```yaml
camera:
  resolution:
    width: 320
    height: 240
```

2. **启用跳帧**：
```yaml
performance:
  skip_frames: 1  # 每2帧处理一次
```

3. **简化姿态估计**：
- 降低关键点数量（暂不推荐）

---

## 演示脚本（毕业答辩用）

### 演示1：完整监测流程（2分钟）
1. **正常状态**（20秒）
   - 端正坐姿，距离70cm
   - 展示：健康分数100%，全绿色

2. **距离过近警告**（30秒）
   - 逐渐靠近到40cm
   - 展示：距离变红，开始计时
   - 持续30秒后触发警告

3. **坐姿不良警告**（40秒）
   - 恢复正常距离，开始低头
   - 展示：Pitch>30°，坐姿变红
   - 持续60秒触发警告

4. **疲劳检测**（30秒）
   - 恢复正常坐姿，闭眼3秒
   - 展示：打瞌睡警告

5. **多重问题**（20秒）
   - 同时：低头+距离过近+闭眼
   - 展示：综合警告，健康分数0%

---

## 验收标准总结

### 必须满足（阶段3）

- [ ] 距离估算基本准确（误差<15cm）
- [ ] 距离<50cm持续30秒触发警告
- [ ] 头部姿态Pitch计算准确
- [ ] 低头>30°持续60秒触发警告
- [ ] 综合健康分数计算正确
- [ ] 多警告合并显示
- [ ] 界面信息清晰完整
- [ ] FPS ≥15
- [ ] 程序稳定运行

### 推荐达到

- [ ] 距离估算误差<10cm
- [ ] 支持焦距校准
- [ ] 3D坐标轴可视化
- [ ] 平滑的角度变化
- [ ] FPS ≥18

---

## 下一步

阶段3完成后，进入**阶段4：多模态提醒系统**

主要任务：
- 语音播报提醒
- LED灯闪烁（树莓派）
- GUI弹窗提醒
- 提醒管理器（防止频繁打扰）

---

**文档版本**: v1.0
**最后更新**: 2025-01-19
**测试状态**: ✅ 待验证
