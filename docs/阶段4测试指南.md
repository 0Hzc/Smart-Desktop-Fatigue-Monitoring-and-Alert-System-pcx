# 阶段4测试指南：多模态提醒系统

## 测试目标

验证三种提醒方式（语音、LED、GUI）均正常工作，提醒及时且不过于频繁。

---

## 测试环境准备

### 1. 更新代码

```bash
git pull origin claude/review-project-plan-01HbXoRc4U8EzYeKMA6bxPxz
```

### 2. 安装依赖

确保已安装pyttsx3语音库：

```bash
pip install pyttsx3
```

### 3. 检查配置

查看`config.yaml`中的提醒配置：

```yaml
alert:
  enable_voice: true   # 启用语音提醒
  enable_led: false    # 启用LED提醒（树莓派）
  enable_gui: true     # 启用GUI弹窗
  cooldown_time: 300   # 提醒冷却时间（秒）
```

**注意**：
- `enable_led`默认为false，因为LED需要树莓派GPIO
- 如果在树莓派上测试，可设置为true并连接LED到GPIO 17
- `cooldown_time`是防止频繁提醒的冷却时间（5分钟）

---

## 独立模块测试

### 测试1：语音提醒器

运行独立测试：

```bash
python src/alert/voice_alert.py
```

**预期结果**：
- ✅ 播放3条测试消息
- ✅ 播放4种预定义提醒（fatigue、distance、posture、severe）
- ✅ 语音清晰可听

**常见问题**：
- 如果没有声音，检查系统音量
- 如果报错`pyttsx3 not found`，运行`pip install pyttsx3`

### 测试2：LED提醒器

运行独立测试：

```bash
python src/alert/led_alert.py
```

**预期结果（非树莓派）**：
- ✅ 显示"模拟模式"提示
- ✅ 打印LED闪烁模拟信息

**预期结果（树莓派）**：
- ✅ LED实际闪烁
- ✅ 测试单次、快速、持续亮起三种模式

**硬件连接**（树莓派）：
```
LED正极 → GPIO 17
LED负极 → 330Ω电阻 → GND
```

### 测试3：GUI弹窗提醒

运行独立测试：

```bash
python src/alert/gui_alert.py
```

**预期结果**：
- ✅ 弹出4个窗口，分别显示不同提醒类型
- ✅ 窗口颜色和图标正确（黄色⚠️警告，红色🚨严重）
- ✅ 窗口自动居中并置顶显示
- ✅ 3秒后自动关闭（或点击"I Understand"手动关闭）

---

## 完整系统测试

### 测试4：提醒触发条件

运行完整系统：

```bash
python main.py
```

#### 4.1 疲劳提醒测试

**操作**：长时间闭眼或频繁眨眼

**触发条件**：
- PERCLOS > 15% 或
- 眨眼频率 < 10次/分钟 或 > 30次/分钟 或
- 连续闭眼 > 2秒

**预期结果**：
- ✅ 界面显示疲劳状态（Mild/Moderate/Severe Fatigue）
- ✅ 健康度下降（-20/-40/-60分）
- ✅ **语音提醒**："You look tired. Please take a break."
- ✅ **GUI弹窗**：黄色警告窗口
- ✅ 5分钟内不重复提醒

#### 4.2 距离过近提醒测试

**操作**：靠近屏幕，使人脸距离 < 50cm

**触发条件**：
- 距离 < 50cm 且持续 30秒

**预期结果**：
- ✅ 界面显示"Too Close!"警告
- ✅ 健康度下降（-20分）
- ✅ **语音提醒**："You are too close to the screen. Please move back."
- ✅ **GUI弹窗**：黄色警告窗口

#### 4.3 坐姿不良提醒测试

**操作**：
- 低头（Pitch > 12°）或
- 抬头（Pitch < -8°）

持续60秒

**触发条件**：
- 不良坐姿持续 > 60秒

**预期结果**：
- ✅ 界面显示"Head Down"或"Head Up"
- ✅ 健康度下降（-20分）
- ✅ **语音提醒**："Poor posture detected: Head Down. Please adjust your sitting position."
- ✅ **GUI弹窗**：黄色警告窗口

#### 4.4 严重疲劳提醒测试（优先级最高）

**操作**：长时间连续闭眼（> 2秒）

**触发条件**：
- Fatigue Level = 3（Severe Fatigue）

**预期结果**：
- ✅ 界面显示"Severe Fatigue"（红色）
- ✅ 健康度大幅下降（-60分）
- ✅ **语音提醒**："Severe fatigue detected! Please rest immediately."
- ✅ **GUI弹窗**：红色严重警告窗口
- ✅ 不会同时触发其他提醒（优先级机制生效）

### 测试5：冷却时间机制

**测试步骤**：
1. 触发疲劳提醒（闭眼）
2. 恢复正常状态
3. **5分钟内**再次触发疲劳提醒

**预期结果**：
- ✅ 第一次提醒正常播放
- ✅ 5分钟内的第二次提醒**不会播放**（冷却时间生效）
- ✅ 终端打印提示："无需重复提醒"（内部日志）

**修改冷却时间**（测试用）：
```yaml
alert:
  cooldown_time: 30  # 改为30秒，方便测试
```

---

## 验收清单

### 功能验收

- [ ] 语音提醒正常工作，声音清晰
- [ ] GUI弹窗显示正常，颜色和图标正确
- [ ] LED提醒工作（树莓派）或模拟模式正常（PC）
- [ ] 疲劳提醒能正确触发
- [ ] 距离提醒能正确触发
- [ ] 坐姿提醒能正确触发
- [ ] 严重疲劳提醒优先级最高
- [ ] 冷却时间机制生效，不会频繁提醒
- [ ] 系统退出时资源正常清理

### 性能验收

- [ ] 提醒不影响主程序运行（FPS保持≥15）
- [ ] 提醒响应及时（检测到异常后1-2秒内触发）
- [ ] 多个提醒可以并发触发（不相互阻塞）

### 配置验收

- [ ] 可以通过config.yaml开关提醒方式
- [ ] 可以调整冷却时间
- [ ] 禁用提醒后不会触发

---

## 故障排除

### 问题1：语音提醒没有声音

**可能原因**：
1. 系统音量为0
2. pyttsx3未安装
3. 语音引擎初始化失败

**解决方案**：
```bash
# 检查pyttsx3
pip list | grep pyttsx3

# 重新安装
pip install --upgrade pyttsx3

# 测试系统音频
speaker-test -t sine -f 1000 -l 1
```

### 问题2：GUI弹窗不显示

**可能原因**：
1. Tkinter未安装
2. 无图形界面环境

**解决方案**：
```bash
# 检查Tkinter
python -m tkinter

# 如果报错，安装Tkinter
# Ubuntu/Debian:
sudo apt-get install python3-tk

# 如果是SSH连接，需要X11转发
ssh -X user@host
```

### 问题3：LED不工作（树莓派）

**可能原因**：
1. RPi.GPIO未安装
2. GPIO权限不足
3. 硬件连接错误

**解决方案**：
```bash
# 安装RPi.GPIO
pip install RPi.GPIO

# 使用sudo运行
sudo python main.py

# 检查GPIO状态
gpio readall
```

### 问题4：提醒过于频繁

**解决方案**：
检查config.yaml中的冷却时间设置：
```yaml
alert:
  cooldown_time: 300  # 增大到300秒（5分钟）
```

---

## 测试报告模板

### 测试日期
YYYY-MM-DD

### 测试环境
- 操作系统：
- Python版本：
- 是否树莓派：

### 测试结果

| 测试项 | 结果 | 备注 |
|--------|------|------|
| 语音提醒独立测试 | ✅/❌ | |
| LED提醒独立测试 | ✅/❌ | |
| GUI弹窗独立测试 | ✅/❌ | |
| 疲劳提醒触发 | ✅/❌ | |
| 距离提醒触发 | ✅/❌ | |
| 坐姿提醒触发 | ✅/❌ | |
| 严重疲劳优先级 | ✅/❌ | |
| 冷却时间机制 | ✅/❌ | |
| 系统性能 | FPS: ___ | |

### 发现的问题

1. 
2. 
3. 

### 改进建议

1. 
2. 
3. 

---

**文档版本**: v1.0
**创建日期**: 2025-01-20
**对应提交**: commit 6de0919
