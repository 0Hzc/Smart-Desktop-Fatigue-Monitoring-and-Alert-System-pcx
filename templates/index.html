<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ¡Œé¢ç–²åŠ³ç›‘æµ‹ç³»ç»Ÿ - Webç•Œé¢</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .video-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }

        #video-stream {
            width: 100%;
            height: auto;
            display: block;
        }

        .connection-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            background: rgba(0,0,0,0.6);
            color: white;
        }

        .status-connected {
            background: rgba(76, 175, 80, 0.8) !important;
        }

        .status-disconnected {
            background: rgba(244, 67, 54, 0.8) !important;
        }

        .status-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .status-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .status-card h3 {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            font-weight: bold;
            color: #666;
        }

        .status-value {
            font-size: 1.1em;
            font-weight: bold;
        }

        .status-normal {
            color: #4CAF50;
        }

        .status-warning {
            color: #FF9800;
        }

        .status-danger {
            color: #F44336;
        }

        /* æé†’å¼¹çª—æ ·å¼ */
        .alert-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .alert-content {
            position: relative;
            margin: 15% auto;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.5);
            animation: slideDown 0.3s;
        }

        @keyframes fadeIn {
            from {opacity: 0;}
            to {opacity: 1;}
        }

        @keyframes slideDown {
            from {transform: translateY(-50px); opacity: 0;}
            to {transform: translateY(0); opacity: 1;}
        }

        .alert-icon {
            font-size: 4em;
            text-align: center;
            margin-bottom: 20px;
        }

        .alert-title {
            font-size: 1.8em;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .alert-message {
            font-size: 1.1em;
            text-align: center;
            color: #666;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .alert-button {
            display: block;
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .alert-button:hover {
            background: #5568d3;
        }

        .alert-warning .alert-title {
            color: #FF9800;
        }

        .alert-critical .alert-title {
            color: #F44336;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ æ™ºèƒ½æ¡Œé¢ç–²åŠ³ç›‘æµ‹ç³»ç»Ÿ</h1>
            <p>å®æ—¶ç›‘æµ‹æ‚¨çš„å¥åº·çŠ¶æ€ | Raspberry Pi 4B</p>
        </div>

        <div class="main-content">
            <!-- è§†é¢‘é¢æ¿ -->
            <div class="video-panel">
                <div class="video-container">
                    <img id="video-stream" src="{{ url_for('video_feed') }}" alt="è§†é¢‘æµåŠ è½½ä¸­...">
                    <div id="connection-status" class="connection-status status-disconnected">
                        â— æœªè¿æ¥
                    </div>
                </div>
            </div>

            <!-- çŠ¶æ€é¢æ¿ -->
            <div class="status-panel">
                <!-- ç–²åŠ³çŠ¶æ€ -->
                <div class="status-card">
                    <h3>ğŸ˜´ ç–²åŠ³çŠ¶æ€</h3>
                    <div class="status-item">
                        <span class="status-label">çŠ¶æ€:</span>
                        <span id="fatigue-status" class="status-value status-normal">æ­£å¸¸</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">EAR:</span>
                        <span id="fatigue-ear" class="status-value">--</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">PERCLOS:</span>
                        <span id="fatigue-perclos" class="status-value">--</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">çœ¨çœ¼é¢‘ç‡:</span>
                        <span id="fatigue-blink" class="status-value">--</span>
                    </div>
                </div>

                <!-- è·ç¦»ç›‘æµ‹ -->
                <div class="status-card">
                    <h3>ğŸ“ è·ç¦»ç›‘æµ‹</h3>
                    <div class="status-item">
                        <span class="status-label">è·ç¦»:</span>
                        <span id="distance-value" class="status-value status-normal">--</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">çŠ¶æ€:</span>
                        <span id="distance-status" class="status-value status-normal">æ­£å¸¸</span>
                    </div>
                </div>

                <!-- åå§¿ç›‘æµ‹ -->
                <div class="status-card">
                    <h3>ğŸª‘ åå§¿ç›‘æµ‹</h3>
                    <div class="status-item">
                        <span class="status-label">Pitch:</span>
                        <span id="posture-pitch" class="status-value">--</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Yaw:</span>
                        <span id="posture-yaw" class="status-value">--</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Roll:</span>
                        <span id="posture-roll" class="status-value">--</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">çŠ¶æ€:</span>
                        <span id="posture-status" class="status-value status-normal">æ­£å¸¸</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æé†’å¼¹çª— -->
    <div id="alert-modal" class="alert-modal">
        <div id="alert-content" class="alert-content">
            <div id="alert-icon" class="alert-icon"></div>
            <div id="alert-title" class="alert-title"></div>
            <div id="alert-message" class="alert-message"></div>
            <button class="alert-button" onclick="closeAlert()">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <script>
        // WebSocketè¿æ¥
        const socket = io();

        // è¿æ¥äº‹ä»¶
        socket.on('connect', function() {
            console.log('WebSocketå·²è¿æ¥');
            document.getElementById('connection-status').className = 'connection-status status-connected';
            document.getElementById('connection-status').textContent = 'â— å·²è¿æ¥';
        });

        socket.on('disconnect', function() {
            console.log('WebSocketå·²æ–­å¼€');
            document.getElementById('connection-status').className = 'connection-status status-disconnected';
            document.getElementById('connection-status').textContent = 'â— æœªè¿æ¥';
        });

        // æ¥æ”¶çŠ¶æ€æ›´æ–°
        socket.on('status_update', function(data) {
            updateFatigueStatus(data.fatigue);
            updateDistanceStatus(data.distance);
            updatePostureStatus(data.posture);
        });

        // æ¥æ”¶æé†’
        socket.on('alert', function(data) {
            showAlert(data);
            playVoice(data.voice_text);  // Webè¯­éŸ³æ’­æ”¾
        });

        // æ›´æ–°ç–²åŠ³çŠ¶æ€
        function updateFatigueStatus(fatigue) {
            const statusElem = document.getElementById('fatigue-status');
            statusElem.textContent = fatigue.description;

            // æ ¹æ®çº§åˆ«è®¾ç½®é¢œè‰²
            statusElem.className = 'status-value ' +
                (fatigue.level === 0 ? 'status-normal' :
                 fatigue.level === 1 ? 'status-warning' :
                 'status-danger');

            document.getElementById('fatigue-ear').textContent = fatigue.ear;
            document.getElementById('fatigue-perclos').textContent = fatigue.perclos + '%';
            document.getElementById('fatigue-blink').textContent = fatigue.blink_rate + ' /min';
        }

        // æ›´æ–°è·ç¦»çŠ¶æ€
        function updateDistanceStatus(distance) {
            document.getElementById('distance-value').textContent = distance.value + ' cm';

            const statusElem = document.getElementById('distance-status');
            if (distance.is_too_close) {
                statusElem.textContent = 'è¿‡è¿‘ï¼';
                statusElem.className = 'status-value status-danger';
            } else {
                statusElem.textContent = 'æ­£å¸¸';
                statusElem.className = 'status-value status-normal';
            }
        }

        // æ›´æ–°åå§¿çŠ¶æ€
        function updatePostureStatus(posture) {
            document.getElementById('posture-pitch').textContent = posture.pitch + 'Â°';
            document.getElementById('posture-yaw').textContent = posture.yaw + 'Â°';
            document.getElementById('posture-roll').textContent = posture.roll + 'Â°';

            const statusElem = document.getElementById('posture-status');
            statusElem.textContent = posture.type;

            statusElem.className = 'status-value ' +
                (posture.is_bad ? 'status-danger' : 'status-normal');
        }

        // æ˜¾ç¤ºæé†’å¼¹çª—
        function showAlert(data) {
            const modal = document.getElementById('alert-modal');
            const content = document.getElementById('alert-content');
            const icon = document.getElementById('alert-icon');
            const title = document.getElementById('alert-title');
            const message = document.getElementById('alert-message');

            // è®¾ç½®å›¾æ ‡å’Œæ ·å¼
            if (data.level === 'critical') {
                icon.textContent = 'ğŸš¨';
                content.className = 'alert-content alert-critical';
            } else {
                icon.textContent = 'âš ï¸';
                content.className = 'alert-content alert-warning';
            }

            title.textContent = data.title;
            message.textContent = data.message;

            modal.style.display = 'block';

            // 5ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(closeAlert, 5000);
        }

        // å…³é—­æé†’
        function closeAlert() {
            document.getElementById('alert-modal').style.display = 'none';
        }

        // Webè¯­éŸ³æ’­æ”¾ï¼ˆä½¿ç”¨Web Speech APIï¼‰
        function playVoice(text) {
            if ('speechSynthesis' in window) {
                // åœæ­¢ä¹‹å‰çš„è¯­éŸ³
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 1.0;  // è¯­é€Ÿ
                utterance.pitch = 1.0;  // éŸ³è°ƒ
                utterance.volume = 1.0;  // éŸ³é‡

                window.speechSynthesis.speak(utterance);
                console.log('æ’­æ”¾è¯­éŸ³:', text);
            } else {
                console.log('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ');
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('alert-modal');
            if (event.target == modal) {
                closeAlert();
            }
        }
    </script>
</body>
</html>
