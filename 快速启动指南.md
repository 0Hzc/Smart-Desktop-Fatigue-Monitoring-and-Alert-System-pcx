# 快速启动指南 - Web版疲劳监测系统

## 🚀 一分钟快速启动

### 1. 拉取最新代码

```bash
cd ~/Smart-Desktop-Fatigue-Monitoring-and-Alert-System-pcx
git pull origin claude/review-project-plan-01HbXoRc4U8EzYeKMA6bxPxz
```

### 2. 安装依赖（首次运行）

```bash
# 安装系统依赖
sudo apt-get update
sudo apt-get install -y python3-opencv espeak

# 安装Python依赖
pip install -r requirements.txt
```

### 3. 启动Web服务器

```bash
python app.py
```

### 4. 访问Web界面

打开浏览器访问：
- **本地**: http://localhost:5000
- **局域网**: http://<树莓派IP>:5000

---

## 📱 设备访问

### 在手机上访问

1. 确保手机和树莓派连接同一WiFi
2. 查看树莓派IP：`hostname -I`
3. 在手机浏览器输入：`http://192.168.1.100:5000`（替换为实际IP）

### 在PC上访问

直接浏览器访问：`http://<树莓派IP>:5000`

---

## ⚙️ 配置说明

### config.yaml 重要参数

```yaml
# 摄像头分辨率（性能优化）
camera:
  resolution:
    width: 640   # 降低到320可提高帧率
    height: 480  # 降低到240可提高帧率

# 提醒阈值（根据实际测试调整）
posture:
  pitch_threshold_down: 12  # 低头角度阈值
  pitch_threshold_up: -8    # 仰头角度阈值
  warning_duration: 60      # 持续60秒触发提醒

# 提醒冷却时间
alert:
  cooldown_time: 300  # 5分钟内不重复提醒

# GPIO模拟模式（外设未到货时保持true）
# LED和蜂鸣器默认使用print模拟
```

---

## 🔧 功能特点

### ✅ 已实现

| 功能 | 状态 | 说明 |
|------|------|------|
| 实时视频流 | ✅ | MJPEG格式，~30 FPS |
| 人脸检测 | ✅ | MediaPipe 468个关键点 |
| 疲劳检测 | ✅ | EAR + PERCLOS + 眨眼频率 |
| 距离监测 | ✅ | 双重方法（人脸框+眼距） |
| 坐姿监测 | ✅ | Pitch/Yaw/Roll 3轴姿态 |
| Web提醒弹窗 | ✅ | 实时推送，5秒自动关闭 |
| Web语音播放 | ✅ | Web Speech API（浏览器TTS） |
| 蜂鸣器提醒 | ⚠️ | 模拟模式（print输出） |
| LED提醒 | ⚠️ | 模拟模式（print输出） |
| 多客户端访问 | ✅ | WebSocket同步状态 |

### ⚠️ 模拟模式

**蜂鸣器和LED默认使用print模拟**
- 原因：外设未到货
- 输出：终端打印模拟信息
- 切换：外设到货后设置`simulate=False`

---

## 📊 提醒触发条件

| 提醒类型 | 触发条件 | 冷却时间 |
|---------|---------|---------|
| **疲劳** | PERCLOS>15% 或眨眼异常 或连续闭眼>2s | 5分钟 |
| **距离** | 距离<50cm 且持续30秒 | 5分钟 |
| **坐姿** | 低头>12° 或抬头<-8°，持续60秒 | 5分钟 |
| **严重疲劳** | 连续闭眼>2秒 | 5分钟 |

---

## 🐛 常见问题

### Q1: 视频流不显示

```bash
# 检查摄像头
ls /dev/video*

# 重启服务
pkill -f app.py
python app.py
```

### Q2: Web语音不播放

Chrome浏览器：
1. 打开 chrome://flags
2. 搜索 "autoplay"
3. 设置为 "No user gesture required"

### Q3: 手机访问不了

```bash
# 检查防火墙
sudo ufw allow 5000/tcp

# 检查IP
hostname -I

# 确保同一WiFi
```

### Q4: FPS太低

修改config.yaml：
```yaml
camera:
  resolution:
    width: 320
    height: 240

performance:
  skip_frames: 2  # 每2帧处理一次
```

---

## 📝 后台运行

### 方法1：nohup

```bash
nohup python app.py > fatigue-monitor.log 2>&1 &

# 查看日志
tail -f fatigue-monitor.log

# 停止
pkill -f app.py
```

### 方法2：systemd服务

```bash
# 创建服务文件
sudo nano /etc/systemd/system/fatigue-monitor.service

# 启动服务
sudo systemctl start fatigue-monitor

# 开机自启动
sudo systemctl enable fatigue-monitor

# 查看状态
sudo systemctl status fatigue-monitor
```

详见：`docs/Ubuntu安装指南.md`

---

## 📚 详细文档

- **完整安装指南**: `docs/Ubuntu安装指南.md`
- **Web版测试指南**: `docs/Web版测试指南.md`
- **阶段3测试指南**: `docs/阶段3测试指南.md`（距离+坐姿）
- **阶段4测试指南**: `docs/阶段4测试指南.md`（提醒系统）

---

## 🎯 测试清单

启动后在浏览器中测试：

- [ ] 视频流正常显示
- [ ] 人脸检测绿框出现
- [ ] 状态卡片实时更新
- [ ] 闭眼2秒触发疲劳提醒
- [ ] 提醒弹窗正常显示
- [ ] Web语音播放（英文TTS）
- [ ] 终端显示蜂鸣器模拟输出
- [ ] 多设备可同时访问

---

## 🔄 外设到货后

### 切换到真实GPIO

#### 1. LED（GPIO 17）

```python
# app.py 中修改
led_alert = LEDAlert(
    pin=led_config['pin'],
    blink_duration=led_config['blink_duration']
)
# 默认会自动检测GPIO，不需要修改代码
```

#### 2. 蜂鸣器（GPIO 18）

```python
# app.py 中修改
self.buzzer = BuzzerAlert(pin=18, simulate=False)  # 改为False
```

#### 3. 硬件连接

```
LED连接：
  LED正极 → GPIO 17 (Pin 11)
  LED负极 → 330Ω电阻 → GND (Pin 6)

蜂鸣器连接：
  蜂鸣器+ → GPIO 18 (Pin 12)
  蜂鸣器- → GND (Pin 14)
```

---

## 💡 优化建议

### 性能优化（树莓派4B）

1. **降低分辨率**: 320x240
2. **跳帧处理**: skip_frames = 2
3. **关闭不必要的日志**: 减少print输出
4. **使用有线连接**: 避免WiFi波动

### 网络优化

1. **使用5G WiFi**: 更低延迟
2. **固定IP**: 避免DHCP变化
3. **端口映射**: 远程访问（不推荐）

---

## 🆘 获取帮助

遇到问题？查看：
1. 终端输出的错误信息
2. 浏览器控制台（F12）
3. `docs/Ubuntu安装指南.md` 故障排除章节

---

**版本**: v2.0 Web版
**最后更新**: 2025-01-20
**项目地址**: Smart-Desktop-Fatigue-Monitoring-and-Alert-System-pcx
